<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£n ƒë·ªì Vi·ªát Nam ‚Äì T√¥ m√†u c√°c t·ªânh ƒë√£ ƒëi</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --visited:#16a34a;   /* xanh l√° */
      --visited-stroke:#0f5132;
      --unvisited:#cbd5e1; /* x√°m nh·∫°t */
      --hover:#0ea5e9;     /* xanh d∆∞∆°ng hover */
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b1020;color:#e5e7eb}
    header{padding:18px 20px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,#0b1020)}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;min-height:calc(100dvh - 70px)}
    aside{border-right:1px solid #1f2937;padding:16px 16px 24px}
    main{padding:16px}
    #map{height:calc(100dvh - 120px);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);border:1px solid #1f2937}
    .panel{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:12px;margin-bottom:12px}
    .panel h3{margin:0 0 10px;font-size:14px;color:#93c5fd}
    .search{display:flex;gap:8px}
    .search input{flex:1;border:1px solid #334155;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px}
    .list{max-height:44dvh;overflow:auto;margin-top:8px}
    .item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;border:1px solid #1f2937;background:#0b1020;margin-bottom:8px}
    .item input{accent-color:var(--visited)}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{background:#0b1020;border:1px dashed #334155;color:#93c5fd;border-radius:999px;padding:4px 10px;font-size:12px}
    .legend{display:flex;gap:10px;align-items:center;margin-top:6px}
    .swatch{width:14px;height:14px;border-radius:3px;border:1px solid #1f2937}
    .note{font-size:12px;color:#9ca3af}
    .btns{display:flex;gap:8px;margin-top:8px}
    button{cursor:pointer;border:none;border-radius:10px;padding:10px 12px;background:#1f2937;color:#e5e7eb}
    .primary{background:#10b981;color:#06281e;font-weight:600}
    .clear{background:#334155}
    .footer{font-size:12px;color:#94a3b8;margin-top:8px}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <header>
    <h1>üó∫Ô∏è B·∫£n ƒë·ªì Vi·ªát Nam ‚Äì ch·ªçn t·ªânh/th√†nh b·∫°n ƒë√£ ƒëi</h1>
  </header>
  <div class="wrap">
    <aside>
      <div class="panel">
        <h3>üîé T√¨m nhanh</h3>
        <div class="search">
          <input id="search" placeholder="G√µ t√™n t·ªânh/th√†nh... (VD: H√† N·ªôi)" />
        </div>
        <div class="legend">
          <div class="swatch" style="background:var(--visited);"></div><span>ƒê√£ ƒëi</span>
          <div class="swatch" style="background:var(--unvisited);"></div><span>Ch∆∞a ƒëi</span>
        </div>
        <div class="btns">
          <button class="primary" id="selectAll">Ch·ªçn t·∫•t c·∫£</button>
          <button class="clear" id="clearAll">B·ªè ch·ªçn</button>
        </div>
      </div>
      <div class="panel">
        <h3>‚úÖ Danh s√°ch ƒë√£ ƒëi (<span id="count">0</span>/63)</h3>
        <div id="picked" class="tags"></div>
        <div class="footer note">M·∫πo: b·∫°n c√≥ th·ªÉ <b>click tr·ª±c ti·∫øp tr√™n b·∫£n ƒë·ªì</b> ƒë·ªÉ b·∫≠t/t·∫Øt m·ªôt t·ªânh.</div>
      </div>
      <div class="panel">
        <h3>üß≠ T·∫•t c·∫£ t·ªânh/th√†nh (63)</h3>
        <div id="list" class="list" aria-live="polite"></div>
      </div>
    </aside>
    <main>
      <div id="map" role="region" aria-label="B·∫£n ƒë·ªì Vi·ªát Nam"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Ngu·ªìn d·ªØ li·ªáu ranh gi·ªõi t·ªânh: OpenDevelopment Mekong (GeoJSON 63 t·ªânh/th√†nh)
    // D√πng link t·∫£i tr·ª±c ti·∫øp ƒë·ªÉ t∆∞∆°ng th√≠ch GitHub Pages
    const GEOJSON_URL = 'https://data.opendevelopmentmekong.net/dataset/999c96d8-fae0-4b82-9a2b-e481f6f50e12/resource/2818c2c5-e9c3-440b-a9b8-3029d7298065/download/diaphantinhenglish.geojson';

    // Tr·∫°ng th√°i l·ª±a ch·ªçn
    const selected = new Set(JSON.parse(localStorage.getItem('visitedProvinces') || '[]'));

    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    const map = L.map('map', { zoomControl: true, attributionControl: true });
    // N·ªÅn t·ªëi nh·∫π cho h·ª£p giao di·ªán
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // L·ªõp GeoJSON to√†n qu·ªëc
    let geoLayer;
    // L∆∞u tham chi·∫øu layer theo t√™n t·ªânh ƒë·ªÉ c·∫≠p nh·∫≠t nhanh
    const byName = new Map();

    // Ti·ªán √≠ch chu·∫©n ho√° t√™n ƒë·ªÉ so s√°nh (b·ªè d·∫•u, kho·∫£ng tr·∫Øng th·ª´a)
    const normalize = s => s
      .normalize('NFD').replace(/\p{Diacritic}/gu, '')
      .replace(/\s+/g,' ').trim().toLowerCase();

    function styleFor(name){
      const picked = selected.has(name);
      return {
        color: picked ? getComputedStyle(document.documentElement).getPropertyValue('--visited-stroke') : '#111827',
        weight: picked ? 1.2 : 0.8,
        fillColor: picked ? getComputedStyle(document.documentElement).getPropertyValue('--visited') : getComputedStyle(document.documentElement).getPropertyValue('--unvisited'),
        fillOpacity: picked ? 0.85 : 0.6
      };
    }

    function updateCount(){
      document.getElementById('count').textContent = selected.size;
    }

    function save(){
      localStorage.setItem('visitedProvinces', JSON.stringify([...selected]));
      updateCount();
      renderPickedTags();
    }

    function renderPickedTags(){
      const box = document.getElementById('picked');
      box.innerHTML = '';
      [...selected].sort((a,b)=>a.localeCompare(b,'vi')).forEach(name => {
        const chip = document.createElement('span');
        chip.className = 'tag';
        chip.textContent = name;
        chip.title = 'Nh·∫•p ƒë·ªÉ b·ªè ch·ªçn';
        chip.onclick = () => toggleByName(name);
        box.appendChild(chip);
      });
    }

    function toggleByName(name){
      if(selected.has(name)) selected.delete(name); else selected.add(name);
      const layer = byName.get(name);
      if(layer){ layer.setStyle(styleFor(name)); }
      // ƒê·ªìng b·ªô checkbox n·∫øu c√≥
      const cb = document.querySelector(`.item input[data-name="${CSS.escape(name)}"]`);
      if(cb) cb.checked = selected.has(name);
      save();
    }

    function makeList(allNames){
      const list = document.getElementById('list');
      list.innerHTML = '';

      // T·∫°o item cho m·ªói t·ªânh
      allNames.sort((a,b)=>a.localeCompare(b,'vi')).forEach(name =>{
        const row = document.createElement('label');
        row.className = 'item';
        row.innerHTML = `
          <input type="checkbox" data-name="${name}"> 
          <span>${name}</span>
        `;
        const cb = row.querySelector('input');
        cb.checked = selected.has(name);
        cb.addEventListener('change', () => toggleByName(name));
        list.appendChild(row);
      });

      // T√¨m ki·∫øm
      const search = document.getElementById('search');
      search.oninput = () => {
        const q = normalize(search.value);
        for(const row of list.children){
          const nm = row.querySelector('span').textContent;
          row.style.display = normalize(nm).includes(q) ? '' : 'none';
        }
      };

      document.getElementById('selectAll').onclick = () => {
        allNames.forEach(n=>selected.add(n));
        byName.forEach((layer,name)=> layer.setStyle(styleFor(name)));
        document.querySelectorAll('.item input').forEach(cb=>cb.checked=true);
        save();
      };
      document.getElementById('clearAll').onclick = () => {
        selected.clear();
        byName.forEach((layer,name)=> layer.setStyle(styleFor(name)));
        document.querySelectorAll('.item input').forEach(cb=>cb.checked=false);
        save();
      };

      updateCount();
      renderPickedTags();
    }

    fetch(GEOJSON_URL)
      .then(r => r.json())
      .then(data => {
        // D·ªØ li·ªáu n√†y c√≥ thu·ªôc t√≠nh t√™n t·ªânh l√† "Name" (ti·∫øng Anh, kh√¥ng d·∫•u)
        const names = new Set();

        geoLayer = L.geoJSON(data, {
          style: f => styleFor(f.properties.Name),
          onEachFeature: (feature, layer) => {
            const name = feature.properties.Name;
            names.add(name);
            byName.set(name, layer);

            layer.bindTooltip(name, {sticky:true, direction:'auto'});

            layer.on('click', () => toggleByName(name));
            layer.on('mouseover', () => layer.setStyle({ color: getComputedStyle(document.documentElement).getPropertyValue('--hover'), weight: 2 }));
            layer.on('mouseout', () => layer.setStyle(styleFor(name)));
          }
        }).addTo(map);

        map.fitBounds(geoLayer.getBounds(), { padding:[20,20] });
        makeList([...names]);
      })
      .catch(err => {
        console.error(err);
        alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu b·∫£n ƒë·ªì. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ t·∫£i l·∫°i trang.');
      });
  </script>
</body>
</html>
